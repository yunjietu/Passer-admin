import{c as e}from"./chaoxing-account-api-LV_gIdy7.js";import{p as a,b as l,s,S as t}from"./index-ZxpkwSGJ.js";import{b as o}from"./ant-design-vue-DFQN5xdf.js";import{r as i,a as d,n as r,m as n,w as u,e as c,b2 as g,ag as p,o as m,bz as v,c as y,u as h,ah as f,b,ai as x,J as w,F as _,be as N}from"./@vue-wTDZSr7R.js";const C={getCurrentPrice:()=>l("/admin/oa/chaoxing-account/price/current"),updatePrice:e=>a("/admin/oa/chaoxing-account/price/update",e)},I={key:0,style:{"margin-top":"4px","font-size":"12px",color:"#666"}},D={style:{display:"flex","align-items":"center",gap:"12px"}},k={style:{"font-size":"12px",color:"#666"}},U={style:{color:"#1677ff","font-weight":"500"}},A={style:{"font-weight":"500",color:"#1677ff"}},E={style:{display:"flex","align-items":"center",gap:"12px"}},P={style:{"font-size":"12px",color:"#666"}},M={style:{color:"#1677ff","font-weight":"500"}},j={style:{display:"flex","align-items":"center"}},z=["src","alt","onError"],$={style:{display:"flex","align-items":"center"}},O=["src","alt","onError"],q=360,F={__name:"chaoxing-account-operate-modal",emits:["refresh"],setup(a,{expose:l,emit:F}){l({showModal:function(a){Object.assign(J,B),W.value=[],X.value=!1,Z.value=void 0,oe(),a?async function(a){try{let l=(await e.detail(a)).data;if(Object.assign(J,l),J.billingMode=l.billingMode||"ACCOUNT",J.dayRemainingDays=l.dayRemainingDays??0,J.dayExtendDays=0,G.value=!l.disabledFlag,l.course){const e=l.courseId&&l.classId?`${l.courseId}_${l.classId}`:l.course,a=l.className?`${l.course}（${l.className}）`:l.course;W.value=[{label:a,value:e,courseName:l.course,courseId:l.courseId,className:l.className,classId:l.classId}],J.course=l.course,Z.value=e}}catch(l){s.captureError(l)}finally{t.hide()}}(a):G.value=!0;R.value=!0,r((()=>{const e=document.getElementsByClassName("ant-modal");e&&e.length>0&&Array.from(e).forEach((e=>{e.childNodes&&e.childNodes.length>0&&Array.from(e.childNodes).forEach((e=>{e.setAttribute&&e.setAttribute("aria-hidden","false")}))}))}))}});const Y=F,R=i(!1);function T(){R.value=!1}const S=i(),B={id:void 0,account:void 0,password:void 0,name:void 0,schoolid:void 0,course:void 0,courseId:void 0,className:void 0,classId:void 0,address:void 0,longitude:void 0,latitude:void 0,disabledFlag:!1,billingMode:"ACCOUNT",dayCount:null,dayRemainingDays:0,dayExtendDays:0};let J=d({...B});const L={account:[{required:!0,message:"请输入账号"}],password:[{required:!0,message:"请输入密码"}],course:[{required:!0,message:"请输入课程"}],address:[{required:!0,message:"请输入地址"}],longitude:[{required:!0,message:"请输入经度"}],latitude:[{required:!0,message:"请输入纬度"}],billingMode:[{required:!0,message:"请选择计费方式"}],dayCount:[{validator:(e,a)=>J.id||"DAY"!==J.billingMode?Promise.resolve():!a||a<=0?Promise.reject("请输入购买天数"):Promise.resolve(),trigger:"change"}],dayExtendDays:[{validator:(e,a)=>J.id&&"DAY"===J.billingMode?!a||a<=0?Promise.resolve():a>q?Promise.reject("追加天数不能超过360"):Promise.resolve():Promise.resolve(),trigger:"change"}]};function V(){S.value.validate().then((async()=>{t.show();try{J.id?await e.update(J):await e.create(J),o.success((J.id?"修改":"添加")+"成功"),T(),Y("refresh")}catch(a){s.captureError(a)}finally{t.hide()}})).catch((e=>{}))}const G=i(!0);function H(e){J.disabledFlag=!e}const K=i(!1),Q=i(!1),W=i([]),X=i(!1),Z=i(void 0),ee=i(null),ae=i(!1);n((()=>"DAY"===J.billingMode));const le=n((()=>null!==ee.value&&Number(ee.value)>0)),se=n((()=>ie(J.dayCount))),te=n((()=>ie(J.dayExtendDays)));async function oe(){ae.value=!0;try{const e=await C.getCurrentPrice();e&&e.data&&void 0!==e.data.dayPrice&&null!==e.data.dayPrice?ee.value=Number(e.data.dayPrice):ee.value=null}catch(e){ee.value=null}finally{ae.value=!1}}function ie(e){if(!le.value)return"";const a=Number(e);return!a||a<=0?"":(a*Number(ee.value)).toFixed(2)}function de(e){const a=e.target.value;J.address=a.replace(/\s+/g,"")}async function re(){if(J.address){K.value=!0;try{const a=J.address.replace(/\s+/g,""),l=await e.getLocationFromAddress({address:a});l.ok&&l.data?(J.longitude=l.data.longitude||"",J.latitude=l.data.latitude||"",o.success("获取经纬度成功")):o.error(l.msg||"获取经纬度失败")}catch(a){o.error("获取经纬度异常")}finally{K.value=!1}}else o.warning("请先输入地址")}function ne(e){X.value=e}function ue(e){const a=W.value.find((a=>a.value===e));a&&(J.course=a.courseName||a.label,J.courseId=a.id||a.courseId,J.className=a.className,J.classId=a.classId)}async function ce(){if(J.account&&J.password){Q.value=!0;try{const a=await e.getChaoxingUserInfo({account:J.account,password:J.password,schoolid:J.schoolid||""});if(!a.ok)return void o.error(a.msg||a.message||"获取信息失败");J.name=a.data.name||"",J.schoolid=a.data.schoolid||"";const l=await e.getChaoxingCourses({account:J.account,password:J.password,schoolid:J.schoolid||""});if(!l.ok||!l.data)return void o.error(l.msg||"获取课程失败");if(l.data.courseDetails&&Array.isArray(l.data.courseDetails))W.value=l.data.courseDetails.map((e=>{const a=e.id&&e.classId?`${e.id}_${e.classId}`:e.name;return{label:e.className?`${e.name}（${e.className}）`:e.name,value:a,courseName:e.name,imageUrl:e.imageUrl,id:e.id,courseId:e.id,className:e.className,classId:e.classId,teacher:e.teacher}}));else{let e=[];l.data.courses?e=l.data.courses.split(",").map((e=>e.trim())):Array.isArray(l.data)?e=l.data:"string"==typeof l.data&&(e=l.data.split(",").map((e=>e.trim()))),W.value=e.map((e=>({label:e,value:e})))}if(W.value.length>0){const e=W.value[0];Z.value=e.value,J.course=e.courseName||e.label,J.courseId=e.id||e.courseId,J.className=e.className,J.classId=e.classId}o.success(`获取信息成功，共${W.value.length}门课程`),W.value.length>0&&(X.value=!0)}catch(a){const e=a?.response?.data?.msg||a?.response?.data?.message||a.message;e&&o.error(e)}finally{Q.value=!1}}else o.warning("请先输入账号和密码")}function ge(e,a){const l=e.target;l.src&&l.src.includes("/chaoxing.png")||(l.src="/chaoxing.png")}return u((()=>J.billingMode),(e=>{"DAY"!==e&&(J.dayCount=null,J.dayExtendDays=0)})),c((()=>{oe()})),(e,a)=>{const l=g("a-input"),s=g("a-form-item"),t=g("a-input-password"),o=g("a-radio"),i=g("a-radio-group"),d=g("a-input-number"),r=g("a-select"),n=g("a-button"),u=g("a-switch"),c=g("a-form"),C=g("a-modal");return m(),p(C,{open:R.value,title:h(J).id?"编辑":"添加",width:700,forceRender:"","ok-text":"确认","cancel-text":"取消",onOk:V,onCancel:T},{default:v((()=>[y(c,{ref_key:"formRef",ref:S,model:h(J),rules:L,"label-col":{span:5},"wrapper-col":{span:18}},{default:v((()=>[y(s,{label:"账号",name:"account"},{default:v((()=>[y(l,{value:h(J).account,"onUpdate:value":a[0]||(a[0]=e=>h(J).account=e),placeholder:"请输入账号",autocomplete:"username",style:{width:"70%","margin-right":"8px"}},null,8,["value"])])),_:1}),y(s,{label:"密码",name:"password"},{default:v((()=>[y(t,{value:h(J).password,"onUpdate:value":a[1]||(a[1]=e=>h(J).password=e),placeholder:"请输入密码",autocomplete:"current-password",style:{width:"70%","margin-right":"8px"}},null,8,["value"])])),_:1}),y(s,{label:"计费方式",name:"billingMode"},{default:v((()=>[x("div",null,[y(i,{value:h(J).billingMode,"onUpdate:value":a[2]||(a[2]=e=>h(J).billingMode=e),disabled:!!h(J).id},{default:v((()=>[y(o,{value:"ACCOUNT"},{default:v((()=>[w("单账号扣费")])),_:1}),y(o,{value:"DAY"},{default:v((()=>[w("单天扣费")])),_:1})])),_:1},8,["value","disabled"]),h(J).id?(m(),b("div",I," 编辑状态下无法修改计费方式，如需调整请新建账号 ")):f("",!0)])])),_:1}),h(J).id||"DAY"!==h(J).billingMode?f("",!0):(m(),p(s,{key:0,label:"购买天数",name:"dayCount"},{default:v((()=>[x("div",D,[y(d,{value:h(J).dayCount,"onUpdate:value":a[3]||(a[3]=e=>h(J).dayCount=e),min:1,max:q,precision:0,style:{width:"100px"}},null,8,["value"]),x("div",k,[ae.value?(m(),b(_,{key:0},[w(" 单价加载中... ")],64)):le.value?(m(),b(_,{key:1},[w(" 预计扣费："),x("span",U,N(se.value||"--"),1),w(" 元 ")],64)):(m(),b(_,{key:2},[w(" 尚未配置单天单价 ")],64))])])])),_:1})),h(J).id&&"DAY"===h(J).billingMode?(m(),b(_,{key:1},[y(s,{label:"剩余天数"},{default:v((()=>[x("div",A,N(h(J).dayRemainingDays||0)+" 天 ",1)])),_:1}),y(s,{label:"追加天数",name:"dayExtendDays"},{default:v((()=>[x("div",E,[y(d,{value:h(J).dayExtendDays,"onUpdate:value":a[4]||(a[4]=e=>h(J).dayExtendDays=e),min:0,max:q,precision:0,placeholder:"输入追加天数",style:{width:"100px"}},null,8,["value"]),x("div",P,[ae.value?(m(),b(_,{key:0},[w(" 单价加载中... ")],64)):le.value?(m(),b(_,{key:1},[w(" 预计扣费："),x("span",M,N(te.value||"--"),1),w(" 元 ")],64)):(m(),b(_,{key:2},[w(" 尚未配置单天单价 ")],64))])])])),_:1})],64)):f("",!0),y(s,{label:"姓名"},{default:v((()=>[y(l,{value:h(J).name,"onUpdate:value":a[5]||(a[5]=e=>h(J).name=e),placeholder:"请输入姓名",style:{width:"70%","margin-right":"8px"}},null,8,["value"])])),_:1}),y(s,{label:"学校ID"},{default:v((()=>[y(l,{value:h(J).schoolid,"onUpdate:value":a[6]||(a[6]=e=>h(J).schoolid=e),placeholder:"请输入学校ID",style:{width:"70%","margin-right":"8px"}},null,8,["value"])])),_:1}),y(s,{label:"课程",name:"course"},{default:v((()=>[y(r,{value:Z.value,"onUpdate:value":a[7]||(a[7]=e=>Z.value=e),placeholder:"请先获取课程列表",style:{width:"70%","margin-right":"8px"},disabled:0===W.value.length,options:W.value,"show-search":"","filter-option":"",open:X.value,onDropdownVisibleChange:ne,onChange:ue,getPopupContainer:e=>e.parentNode},{option:v((({label:e,value:a,imageUrl:l,id:s})=>[x("div",j,[x("img",{src:l||"/chaoxing.png",alt:e,style:{width:"24px",height:"24px","margin-right":"8px","border-radius":"4px","object-fit":"cover"},referrerpolicy:"no-referrer",loading:"lazy",onError:e=>ge(e)},null,40,z),x("span",null,N(e),1)])])),value:v((({value:e,label:a,imageUrl:l,id:s})=>[x("div",$,[x("img",{src:l||"/chaoxing.png",alt:a,style:{width:"16px",height:"16px","margin-right":"6px","border-radius":"2px","object-fit":"cover"},referrerpolicy:"no-referrer",loading:"lazy",onError:e=>ge(e)},null,40,O),x("span",null,N(a),1)])])),_:1},8,["value","disabled","options","open","getPopupContainer"]),y(n,{type:"primary",size:"small",onClick:ce,loading:Q.value},{default:v((()=>[w("获取信息")])),_:1},8,["loading"])])),_:1}),y(s,{label:"地址",name:"address"},{default:v((()=>[y(l,{value:h(J).address,"onUpdate:value":a[8]||(a[8]=e=>h(J).address=e),placeholder:"请输入地址",style:{width:"70%","margin-right":"8px"},onInput:de},null,8,["value"]),y(n,{type:"primary",size:"small",onClick:re,loading:K.value},{default:v((()=>[w("获取")])),_:1},8,["loading"])])),_:1}),y(s,{label:"经度",name:"longitude"},{default:v((()=>[y(l,{value:h(J).longitude,"onUpdate:value":a[9]||(a[9]=e=>h(J).longitude=e),placeholder:"请输入经度",style:{width:"70%","margin-right":"8px"}},null,8,["value"])])),_:1}),y(s,{label:"纬度",name:"latitude"},{default:v((()=>[y(l,{value:h(J).latitude,"onUpdate:value":a[10]||(a[10]=e=>h(J).latitude=e),placeholder:"请输入纬度",style:{width:"70%","margin-right":"8px"}},null,8,["value"])])),_:1}),y(s,{label:"启用状态",name:"disabledFlag"},{default:v((()=>[y(u,{checked:G.value,"onUpdate:checked":a[11]||(a[11]=e=>G.value=e),onChange:H},null,8,["checked"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open","title"])}}},Y=Object.freeze(Object.defineProperty({__proto__:null,default:F},Symbol.toStringTag,{value:"Module"}));export{F as _,Y as a,C as c};
