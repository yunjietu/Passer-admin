import e from"./index-BeKZG1Ep.js";import{_ as a,c as t,z as l,d as n,P as i,h as o,s,A as r,S as d}from"./index-ZxpkwSGJ.js";import{S as c,a5 as p,a0 as u,E as m}from"./@ant-design-rHMPkvPq.js";import{b as g,M as y}from"./ant-design-vue-DFQN5xdf.js";import{a as f,r as v,e as h,b2 as x,b,o as w,c as k,bz as j,ai as I,J as _,u as z,ah as N,ag as C,be as S,aY as E,aW as F,h as $}from"./@vue-wTDZSr7R.js";import"./clipboard-W6UwraYJ.js";import"./vue-DiME50Ru.js";import"./@ctrl-B1U3vBhl.js";import"./lodash-DJa03WnC.js";import"./vue3-json-viewer-BcgvkQJY.js";import"./dayjs-CSPdbndm.js";import"./vue-i18n-DNlNJnDH.js";import"./@intlify-BXJl0ReV.js";import"./pinia-BY_IhmGU.js";import"./axios-BlN9Xwzv.js";import"./crypto-js-VShT-BxW.js";import"./sm-crypto-BtLvRUKc.js";import"./jsbn-qAKIvbVZ.js";import"./nprogress-DmlD4NmX.js";import"./vue-router-BJIyZwNj.js";import"./mitt-CNZ6avp8.js";import"./@babel-rSvM8Ko2.js";import"./resize-observer-polyfill-OVnto9HH.js";import"./@emotion-COtJ1lvC.js";import"./stylis-Bzr8AwGH.js";import"./vue-types-BvQfMnDx.js";import"./dom-align-CCb293uS.js";import"./lodash-es-DiERF9Dp.js";import"./async-validator-BTKOuuO-.js";import"./throttle-debounce-w9OM8Bxz.js";const B={class:"my-agent-page"},P={class:"page-header"},U={class:"filter-bar"},M={class:"search-row"},O={class:"invite-row"},D=(e=>(E("data-v-9475c9b6"),e=e(),F(),e))((()=>I("span",{class:"invite-label"},"邀请码开关",-1))),L={key:0,class:"smart-margin-left10 permission-tip"},T={key:1,class:"balance-cell"},A={class:"balance-amount"},q={key:2,class:"smart-table-operate"},J={class:"smart-query-table-page"},W=a({__name:"index",setup(a){const E=[{title:"账号ID",dataIndex:"employeeId",width:120,align:"center"},{title:"姓名",dataIndex:"actualName",width:120,align:"center"},{title:"登录账号",dataIndex:"loginName",width:150,align:"center"},{title:"手机号",dataIndex:"phone",width:140},{title:"邮箱",dataIndex:"email",width:180},{title:"角色",dataIndex:"roleNameList",ellipsis:!0},{title:"部门",dataIndex:"departmentName",ellipsis:!0},{title:"余额",dataIndex:"balance",width:160,align:"center"},{title:"邀请时间",dataIndex:"createTime",width:180},{title:"状态",dataIndex:"disabledFlag",width:100},{title:"操作",dataIndex:"operate",width:200}],F={keyword:void 0,disabledFlag:void 0,pageNum:1,pageSize:t},W=f({...F}),Q=v(!1),R=v([]),Y=v(0),G=v(),H=v(!1),K=v(!1),V=f({employeeId:null,agentName:"",amount:null,remark:""}),X=l(),Z=v(!1),ee=v(""),ae=v(!1);async function te(){Q.value=!0;try{const e=await o.queryMyAgents(W),a=e?.data?.list??[],t={};a.length&&await Promise.all(a.filter((e=>e?.employeeId)).map((async e=>{try{const a=await o.getBalance(e.employeeId);t[e.employeeId]=a?.data?.balance??0}catch(a){s.captureError(a),t[e.employeeId]="--"}}))),R.value=a.map((e=>({...e,roleNameList:e.roleNameList?.length?e.roleNameList.join(", "):"--",balance:t[e.employeeId]??"--"}))),Y.value=e?.data?.total??0}catch(e){s.captureError(e),g.error("查询失败，请稍后再试")}finally{Q.value=!1}}function le(){W.pageNum=1,te()}function ne(){le()}function ie(){le()}function oe(e,a){W.pageNum=e,W.pageSize=a,te()}function se(){Object.assign(W,F),te()}function re({title:e,content:a,onOk:t}){y.confirm({title:"提醒",icon:k(m),content:a,okText:"确定",okType:"danger",async onOk(){d.show();try{await t()}catch(e){s.captureError(e)}finally{d.hide()}},cancelText:"取消"})}function de(e,a="操作"){return!!e?.employeeId||(g.error(`未找到员工ID，无法${a}`),!1)}async function ce(){if(null!==V.amount&&void 0!==V.amount&&""!==V.amount){K.value=!0;try{await o.transferBalance(V.employeeId,V.amount,V.remark),g.success("充值成功"),H.value=!1,te()}catch(e){s.captureError(e);const a=e?.response?.data?.msg||e?.message||"充值失败，请稍后再试";g.error(a)}finally{K.value=!1}}else g.error("请输入充值金额")}function pe(){H.value=!1,V.employeeId=null,V.agentName="",V.amount=null,V.remark=""}function ue(){ee.value=""}async function me(e){try{ae.value=!0,await o.toggleInviteCode(e),g.success(e?"邀请码已开启":"邀请码已关闭"),e?await ge():ue()}catch(a){s.captureError(a)}finally{ae.value=!1}}async function ge(){try{const e=await o.getMyInviteCode();ee.value=e.data}catch(e){s.captureError(e)}}function ye(){const e=ee.value;if(!e)return void g.warning("邀请码为空，无法复制");const a=document.createElement("textarea");a.value=e,a.style.position="fixed",a.style.left="-999999px",a.style.top="-999999px",document.body.appendChild(a),a.focus(),a.select();try{document.execCommand("copy")?g.success("邀请码已复制"):g.error("复制失败，请手动复制")}catch(t){g.error("复制失败，请手动复制")}finally{document.body.removeChild(a)}}return h((()=>{te(),async function(){try{const e=(await r.getLoginInfo()).data;e.inviteEnabled&&e.invitePermission?(Z.value=!0,await ge()):(Z.value=!1,ue())}catch(e){s.captureError(e)}}()})),(a,t)=>{const l=x("a-typography-title"),r=x("a-typography-text"),d=x("a-radio-button"),m=x("a-radio-group"),f=x("a-button"),v=x("a-input-search"),h=x("a-switch"),F=x("a-tag"),le=x("a-table"),ue=x("a-pagination"),ge=x("a-input"),fe=x("a-form-item"),ve=x("a-input-number"),he=x("a-textarea"),xe=x("a-form"),be=x("a-modal"),we=x("a-card");return w(),b("div",B,[k(we,{class:"my-agent-card",size:"small",bordered:!1,"body-style":{padding:"20px 20px 12px"}},{default:j((()=>[I("div",P,[I("div",null,[k(l,{level:4,class:"title"},{default:j((()=>[_("我的代理")])),_:1}),k(r,{type:"secondary"},{default:j((()=>[_("查看由我邀请的成员并支持筛选")])),_:1})]),k(m,{value:W.disabledFlag,"onUpdate:value":t[0]||(t[0]=e=>W.disabledFlag=e),size:"small",onChange:ie},{default:j((()=>[k(d,{value:void 0},{default:j((()=>[_("全部")])),_:1}),k(d,{value:!1},{default:j((()=>[_("启用")])),_:1}),k(d,{value:!0},{default:j((()=>[_("禁用")])),_:1})])),_:1},8,["value"])]),I("div",U,[I("div",M,[k(v,{value:W.keyword,"onUpdate:value":t[1]||(t[1]=e=>W.keyword=e),valueModifiers:{trim:!0},placeholder:"账号ID / 姓名 / 手机号 / 登录账号","allow-clear":"",onSearch:ne},{enterButton:j((()=>[k(f,{type:"primary"},{icon:j((()=>[k(z(c))])),default:j((()=>[_(" 查询 ")])),_:1})])),_:1},8,["value"]),k(f,{class:"smart-margin-left10",onClick:se},{icon:j((()=>[k(z(p))])),default:j((()=>[_(" 重置 ")])),_:1})]),I("div",O,[D,k(h,{checked:Z.value,"onUpdate:checked":t[2]||(t[2]=e=>Z.value=e),onChange:me,loading:ae.value,disabled:!z(X).invitePermission,class:"smart-margin-left10 invite-switch"},null,8,["checked","loading","disabled"]),z(X).invitePermission?N("",!0):(w(),b("span",L,"(需上级授权)")),Z.value&&ee.value?(w(),C(v,{key:1,value:ee.value,readonly:"",placeholder:"我的邀请码",class:"smart-margin-left10 invite-code-input"},{enterButton:j((()=>[k(f,{type:"primary",onClick:ye},{icon:j((()=>[k(z(u))])),default:j((()=>[_(" 复制 ")])),_:1})])),_:1},8,["value"])):N("",!0)])]),k(le,{columns:E,"data-source":R.value,loading:Q.value,pagination:!1,"row-key":"employeeId",bordered:"",size:"middle",scroll:{x:"max-content"}},{bodyCell:j((({column:e,text:a,record:t})=>["disabledFlag"===e.dataIndex?(w(),C(F,{key:0,color:a?"error":"processing"},{default:j((()=>[_(S(a?"禁用":"启用"),1)])),_:2},1032,["color"])):"balance"===e.dataIndex?(w(),b("div",T,[I("span",A,S(t.balance??"--"),1),k(f,{type:"link",size:"small",onClick:e=>function(e){if(!de(e,"查询余额"))return;const a={employeeId:e.employeeId,pageNum:1,pageSize:50};o.getBalanceLogs(a).then((a=>{const t=a?.data?.list??[],l=Math.min(820,Math.round(.95*window.innerWidth));y.info({title:`余额明细 - ${e.actualName}`,width:l,centered:!0,okText:"知道了",content:$("div",{style:"text-align:left; max-height: 60vh; overflow-y: auto;"},[$("div",{style:"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"},[$("div",{style:"font-weight:600;"},"当前余额："),$("div",{style:"font-size:16px;color:#1890ff;font-weight:600;"},`￥${Number(e.balance??0).toFixed(2)}`)]),$("table",{class:"ant-table",style:"width:100%;margin-top:8px;border-collapse:collapse;font-size:12px;"},[$("thead",{},[$("tr",{},[$("th",{style:"padding:8px 12px;text-align:center;background:#fafafa;position:sticky;top:0;"},"时间"),$("th",{style:"padding:8px 12px;text-align:center;background:#fafafa;position:sticky;top:0;"},"类型"),$("th",{style:"padding:8px 12px;text-align:right;background:#fafafa;position:sticky;top:0;"},"变动金额"),$("th",{style:"padding:8px 12px;text-align:right;background:#fafafa;position:sticky;top:0;"},"变动后余额"),$("th",{style:"padding:8px 12px;text-align:left;background:#fafafa;position:sticky;top:0;"},"备注")])]),$("tbody",{},t.map(((e,a)=>{const t=Number(e.amount||0),l=Number(e.afterBalance||0);return $("tr",{style:`background:${a%2==1?"#fafafa":"#fff"};`},[$("td",{style:"padding:8px 12px;text-align:center;white-space:nowrap;"},e.createTime),$("td",{style:"padding:8px 12px;text-align:center;"},1===e.type?"充值":"消费"),$("td",{style:`padding:8px 12px;text-align:right;color:${t>=0?"#52c41a":"#cf1322"};font-weight:600;`},`${t>=0?"+":""}￥${Math.abs(t).toFixed(2)}`),$("td",{style:"padding:8px 12px;text-align:right;"},`￥${l.toFixed(2)}`),$("td",{style:"padding:8px 12px;text-align:left;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"},e.remark||"")])})))])])})})).catch((e=>{s.captureError(e),g.error("获取余额明细失败")}))}(t)},{default:j((()=>[_("明细")])),_:2},1032,["onClick"])])):"operate"===e.dataIndex?(w(),b("div",q,[k(f,{type:"link",size:"small",onClick:e=>function(e){de(e,"充值")&&(V.employeeId=e.employeeId,V.agentName=e.actualName||e.loginName||"--",V.amount=null,V.remark="",H.value=!0)}(t)},{default:j((()=>[_("充值")])),_:2},1032,["onClick"]),k(f,{type:"link",size:"small",onClick:e=>function(e){re({content:"确定要重置密码吗?",async onOk(){const{data:a}=await o.resetAgentPassword(e.employeeId);g.success("重置成功"),G.value?.showModal(e.loginName,a),te()}})}(t)},{default:j((()=>[_("重置密码")])),_:2},1032,["onClick"]),k(f,{type:"link",size:"small",onClick:e=>function(e){const a=e.disabledFlag?"启用":"禁用";re({content:`确定要${a}吗?`,async onOk(){await o.updateAgentDisabled(e.employeeId),g.success(`${a}成功`),te()}})}(t)},{default:j((()=>[_(S(t.disabledFlag?"启用":"禁用"),1)])),_:2},1032,["onClick"])])):N("",!0)])),_:1},8,["data-source","loading"]),I("div",J,[k(ue,{showSizeChanger:"",showQuickJumper:"",pageSizeOptions:z(i),defaultPageSize:W.pageSize,current:W.pageNum,"onUpdate:current":t[3]||(t[3]=e=>W.pageNum=e),pageSize:W.pageSize,"onUpdate:pageSize":t[4]||(t[4]=e=>W.pageSize=e),total:Y.value,onChange:oe,onShowSizeChange:oe,"show-total":z(n)},null,8,["pageSizeOptions","defaultPageSize","current","pageSize","total","show-total"])]),k(e,{ref_key:"employeePasswordDialog",ref:G},null,512),k(be,{open:H.value,"onUpdate:open":t[8]||(t[8]=e=>H.value=e),title:"给代理充值","confirm-loading":K.value,onOk:ce,onCancel:pe},{default:j((()=>[k(xe,{model:V,"label-col":{span:6},"wrapper-col":{span:16}},{default:j((()=>[k(fe,{label:"代理姓名"},{default:j((()=>[k(ge,{value:V.agentName,"onUpdate:value":t[5]||(t[5]=e=>V.agentName=e),disabled:""},null,8,["value"])])),_:1}),k(fe,{label:"充值金额",required:""},{default:j((()=>[k(ve,{value:V.amount,"onUpdate:value":t[6]||(t[6]=e=>V.amount=e),min:0,precision:2,max:999999,style:{width:"100%"},placeholder:"请输入正确充值金额",onBlur:a.validateRechargeAmount},null,8,["value","onBlur"])])),_:1}),k(fe,{label:"备注"},{default:j((()=>[k(he,{value:V.remark,"onUpdate:value":t[7]||(t[7]=e=>V.remark=e),maxlength:25,rows:1,placeholder:"请输入备注（可选，最多25字符）"},null,8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open","confirm-loading"])])),_:1})])}}},[["__scopeId","data-v-9475c9b6"]]);export{W as default};
